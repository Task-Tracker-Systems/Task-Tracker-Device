<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Task Tracker: DR004 Direct Usage of Hardware Abstraction Layer</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Task Tracker
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.xhtml');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">DR004 Direct Usage of Hardware Abstraction Layer </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md31"></a>
Context</h1>
<p >Currently, we are in violation of the requirement to only use libraries and frameworks through adapters, as mandated by the objectives of the software architecture (see <a class="el" href="software_architecture.xhtml#flexible_structure">relevant section in Software Architecture</a>). Currently, we utilize an implementation of the <a href="https://github.com/arduino/ArduinoCore-API">ArduinoCore-API</a> (ACA) as a hardware abstraction layer (HAL) from outside the adapters layer. More specifically, we employ an implementation of the ACA from Espressif, tailored for ESP32s.</p>
<p >It is generally understood that using HALs is only necessary from the <a class="el" href="board_adapters.xhtml">board adapters package</a>.</p>
<h1><a class="anchor" id="autotoc_md32"></a>
Options</h1>
<p >There are several options for resolving this violation of our own rules.</p>
<h2><a class="anchor" id="autotoc_md33"></a>
Option 1</h2>
<p >Adhere to the current guidelines.</p>
<p >According to the current state of the software architecture, we should use the 3rd party HAL indirectly through adapters. These adapters would reside in the <a class="el" href="third_party_adapters.xhtml">3rd party adapters package</a>.</p>
<h3><a class="anchor" id="autotoc_md34"></a>
Option 1a)</h3>
<p >For an object-oriented (OO) variant, defining an interface and inheriting from it would require:</p>
<ul>
<li>Defining one or several interfaces inside the <a class="el" href="board_adapters.xhtml">board adapters package</a> (header files).</li>
<li>Implementing those as adapters inside the <a class="el" href="third_party_adapters.xhtml">3rd party adapters package</a> (source files).</li>
<li>Defining interfaces for the factories (see <a class="el" href="software_architecture.xhtml#dependency_injection">dependency injection</a>) inside the <a class="el" href="board_adapters.xhtml">board adapters package</a> (header files).</li>
<li>Implementing those factories inside the <a class="el" href="third_party_adapters.xhtml">3rd party adapters package</a> (source files).</li>
</ul>
<p >This is the typical way dependency injection, and therefore the <a class="el" href="software_architecture.xhtml#interpretation_dependency_rule">dependency rule</a>, is implemented.</p>
<h3><a class="anchor" id="autotoc_md35"></a>
Option 1b)</h3>
<p >Instead of using an object-oriented approach using inheritance, one could create an interface to the HAL based on free functions.</p>
<p >This option would require:</p>
<ul>
<li>Defining one or several interfaces (free function declarations) inside the <a class="el" href="board_adapters.xhtml">board adapters package</a> (header files).</li>
<li>Implementing those as adapters inside the <a class="el" href="third_party_adapters.xhtml">3rd party adapters package</a> (source files).</li>
<li>If the build configuration (see <a href="https://docs.platformio.org/en/latest/projectconf/sections/env/options/library/lib_ldf_mode.html" title="PlatformIO documentation of lib_ldf_mode"><code>lib_ldf_mode</code></a>) requires it, one may have to define <a class="el" href="proxy_header.xhtml">proxy headers</a> (header files).</li>
</ul>
<p >Factories are not necessary because this approach does not rely on objects.</p>
<h3><a class="anchor" id="autotoc_md36"></a>
Option 1c)</h3>
<p >A hybrid approach (OO and free functions) is also possible. This would fit well with the ACA as it also consists of classes and free functions.</p>
<p >The required steps would be a mixture of those of options 1a) and 1b).</p>
<h2><a class="anchor" id="autotoc_md37"></a>
Option 2</h2>
<p >Change the current guidelines so that direct dependency on 3rd party HALs is allowed within hardware-related packages (currently only the <a class="el" href="board_adapters.xhtml">board adapters package</a>).</p>
<p >This approach eliminates the requirement to define 3rd party adapters for the HAL.</p>
<p >In order to test code depending on the ACA, the 3rd party interface needs to be stubbed. <em>For vanilla ACA, stubbing the proprietary interface can be greatly simplified by using <a href="https://platformio.org/lib/show/1689/ArduinoFake" title="ArduinoFake in PlaftormIO&apos;s registry">ArduinoFake</a>.</em> We utilize an <a href="https://github.com/espressif/arduino-esp32/">implementation of the Arduino Core API (ACA) specific for ESP32s by Espressif</a> which extends the ACA. Following this option's approach, to directly use ACA and ArduinoFake for testing, we would need to manage the extensions separately. The following variants of this option specify different methods to handle the extensions.</p>
<h3><a class="anchor" id="autotoc_md38"></a>
Option 2a)</h3>
<p >Instead of directly using a modified Arduino interface provided by the extensions (for example for a specific <code>class</code>), we use an adapter. The adapters would be integrated just as for option 1. But compared to option 1, this only needs to be done for those smallest indivisible interfaces which are not compatible with the vanilla ACA.</p>
<h3><a class="anchor" id="autotoc_md39"></a>
Option 2b)</h3>
<p >At those places in the source code where extensions are used, we introduce conditionally compiled sections. One section uses the modified version of the ACA, necessary for the productive code. The alternative section is used when compiling for native tests. It uses the vanilla ACA which can be simply stubbed using ArduinoFake.</p>
<p >The selection of conditionally compiled sections is done using <code>constexpr if</code>, where possible. Else, the C preprocessor (CPP) is used for conditional inclusion (<code>#if</code>, ...).</p>
<h1><a class="anchor" id="autotoc_md40"></a>
Comparison of Options</h1>
<h2><a class="anchor" id="autotoc_md41"></a>
Comparing variants Option 1a), b), and c)</h2>
<p >Assuming that we do define interfaces for one or several HALs, we should not follow the structure of the currently used one just for convenience (as option 1c suggests). This could complicate writing adapters for different HAL implementations. Allowing variants is one of the purposes of the adapters.</p>
<p >Instead, we should design the interfaces to fit the usage. In general, an object-oriented approach is sensible to represent the different peripheral components available through HALs. Also, an object-oriented approach is the most straightforward for implementing dependency inversion.</p>
<p >From these variants, <b>option 1a)</b> would be the best.</p>
<h2><a class="anchor" id="autotoc_md42"></a>
Comparing Options 1a), 2a), and 2b)</h2>
<ul>
<li><b>Option 1a)</b>: Implement and use adapters for the complete 3rd party HAL(s)<ul>
<li>Pros:<ul>
<li>Clean separation of concerns, dependency inversion, and injection.</li>
<li>Fits the overall design to use dependency inversion to fulfill the <a class="el" href="software_architecture.xhtml#interpretation_dependency_rule">dependency rule</a>.</li>
<li>Using a different implementation of our - to be defined - HAL interface would not require modifying the users of our HAL interface. Instead, only a different adapter - implementing our HAL interface - would be required.<a class="el" href="md_doc_decisions_dr_004.xhtml#dr004_1">¹</a></li>
</ul>
</li>
<li>Cons:<ul>
<li>This approach requires writing adapters for all used HAL interfaces to 3rd party libraries. Designing a reusable interface is challenging, and the adapters may result in boilerplate code. Note that this approach would mean writing adapters to a HAL implementation, which is an adapter (to proprietary peripheral drivers) in itself.</li>
</ul>
</li>
</ul>
</li>
<li><b>Option 2a)</b>: Use adapters only for extensions to vanilla ACA<ul>
<li>Pros:<ul>
<li>Compared to option 1a), only a fraction of the adapters would need to be written.</li>
</ul>
</li>
<li>Cons:<ul>
<li>Our board adapters would have a high degree of dependency on the ACA. The <em>Single Responsibility Principle</em> is violated<a class="el" href="md_doc_decisions_dr_004.xhtml#dr004_2">²</a> as the board adapters would not only depend on the board and its hardware but also on an interface of a 3rd party HAL.</li>
<li>Dealing with the extensions made compared to vanilla ACA requires writing some adapters.</li>
<li>Adapting a variation from the ACA in one member function of a class requires creating an interface containing all used member functions of that class, even if those other member functions are used without alterations. This introduces <em>boilerplate code</em>.</li>
</ul>
</li>
</ul>
</li>
<li><b>Option 2b)</b>: Use alternative sections within source files<ul>
<li>Pros:<ul>
<li>Reduces the need for additional code to a minimum. No adapters need to be written to use the HAL.</li>
</ul>
</li>
<li>Cons:<ul>
<li>Our board adapters would have a high degree of dependency on the ACA. The <em>Single Responsibility Principle</em> is violated<a class="el" href="md_doc_decisions_dr_004.xhtml#dr004_2">²</a> even further (compared to option 2a)) by depending on the vanilla ACA required for testing in the native build environment only. Changes to the test infrastructure should not necessitate changes in the source file containing productive code.</li>
<li>In general, conditionally compiled sections of code reduces its readability.</li>
</ul>
</li>
</ul>
</li>
</ul>
<dl class="section note"><dt>Note</dt><dd><a class="anchor" id="dr004_1"></a>¹: <em>In practice</em>, our HAL interface may not be suitable to accommodate the new HAL implementation (see <a href="https://en.wikipedia.org/w/index.php%3Ftitle%3DRule_of_three_%28computer_programming%29%26oldid%3D1173684754">Rule of Three</a>). Thus, we would have to adjust our HAL interface and the code using it accordingly. In other words, it is difficult to design a HAL interface such that we would actually benefit when changing the HAL implementation to a different 3rd party library. Thus, this advantage may not be relevant for that case. <br  />
 Also, in case the HAL implementation is changed, it may be less effort to adjust all the uses of the new HAL interface than to write adapters for the changed 3rd party library.</dd>
<dd>
<a class="anchor" id="dr004_2"></a>²: The source file (of a non-adapter) would depend on a 3rd party interface. Changes to that 3rd party interface may necessitate changes to the source file even though the requirements to that source file remain the same.</dd></dl>
<h2><a class="anchor" id="autotoc_md43"></a>
Summary &amp; Decision</h2>
<p >Writing adapters adds additional effort, potentially resulting in boilerplate code, and the advantage is dubious.</p>
<p >After careful consideration, we've decided on:</p>
<blockquote class="doxtable">
<p >&zwj;<b>Option 2:</b> Allow direct dependencies from hardware-related code to 3rd party HAL interfaces. </p>
</blockquote>
<p>And more specifically for testing on native environments, use:</p>
<blockquote class="doxtable">
<p >&zwj;<b>Option 2b):</b> Where the ACA is used, it is allowed to add small conditionally compiled sections for tests to cope with deviations of the ACA used in productive code from the vanilla ACA. </p>
</blockquote>
<p>The latter relaxation is to facilitate the use of ArduinoFake to stub the HAL's interface. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun Feb 25 2024 17:58:48 for Task Tracker by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5
</small></address>
</body>
</html>
